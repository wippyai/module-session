version: "1.0"
namespace: wippy.session.process

entries:
  # wippy.session.process:command_bus
  - name: command_bus
    kind: library.lua
    meta:
      comment: Operation queuing and coordination system for session processing
      description: Manages operation queues, handler mounting, and async operation processing
    source: file://command_bus.lua

  # wippy.session.process:upstream
  - name: upstream
    kind: library.lua
    meta:
      comment: Session upstream for sending notifications and updates to clients
      description: Handles communication between session process and upstream systems
    source: file://upstream.lua
    imports:
      consts: wippy.session:consts

  # wippy.session.process:session_handlers
  - name: session_handlers
    kind: library.lua
    meta:
      comment: Session management and background operation handlers
      description: Handles agent/model changes, title generation, and checkpointing
    source: file://session_handlers.lua
    modules:
      - funcs
      - time
    imports:
      consts: wippy.session:consts
      tool_caller: wippy.agent.tools:caller

  # wippy.session.process:control_handlers
  - name: control_handlers
    kind: library.lua
    meta:
      comment: Control directive handlers for system operations
      description: Handles artifacts, context, memory, and configuration control directives
    source: file://control_handlers.lua
    modules:
      - json
      - uuid
    imports:
      consts: wippy.session:consts

  # wippy.session.process:message_handlers
  - name: message_handlers
    kind: library.lua
    meta:
      comment: Core message flow handlers for conversation processing
      description: Handles user messages, agent responses, and tool execution flow
    source: file://message_handlers.lua
    modules:
      - json
      - uuid
      - funcs
      - time
    imports:
      consts: wippy.session:consts
      agent_context: wippy.agent:context
      prompt_builder: wippy.session:prompt_builder
      tool_caller: wippy.agent.tools:caller

  # wippy.session.process:session
  - name: session
    kind: process.lua
    meta:
      comment: Minimalistic session process for message handling with command bus
      description: Core session process that uses command bus for operation coordination
      default_host: app:processes
    source: file://session.lua
    modules:
      - logger
    imports:
      consts: wippy.session:consts
      reader: wippy.session.persist:reader
      writer: wippy.session.persist:writer
      upstream: wippy.session.process:upstream
      command_bus: wippy.session.process:command_bus
      message_handlers: wippy.session.process:message_handlers
      control_handlers: wippy.session.process:control_handlers
      session_handlers: wippy.session.process:session_handlers
      agent_context: wippy.agent:context
    method: run

  # wippy.session.process:plugin
  - name: plugin
    kind: process.lua
    meta:
      comment: Session management plugin for relay system
      description: Manages session lifecycle, routing, and user session limits
      type: relay.plugin
      command_prefix: "session_"
      auto_start: true
      default_host: app:processes
    source: file://plugin.lua
    modules:
      - time
      - json
      - uuid
      - logger
    imports:
      consts: wippy.session:consts
      session_repo: wippy.session.persist:session_repo
      context_repo: wippy.session.persist:context_repo
      start_tokens: wippy.session:start_tokens
    method: run
