version: "1.0"
namespace: wippy.session

entries:
  - name: definition
    kind: ns.definition
    meta:
      title: Session
      description: User sessions and conversation management

  # wippy.session:api_router
  - name: api_router
    kind: ns.requirement
    meta:
      description: Injects API router configuration into endpoints
      parent: app.deps:dep.wippy.session
    targets:
      - entry: wippy.session.api:delete_session
        path: .meta.router
      - entry: wippy.session.api:delete_session.endpoint
        path: .meta.router
      - entry: wippy.session.api:get_artifact
        path: .meta.router
      - entry: wippy.session.api:get_artifact.endpoint
        path: .meta.router
      - entry: wippy.session.api:get_artifact_content
        path: .meta.router
      - entry: wippy.session.api:get_artifact_content.endpoint
        path: .meta.router
      - entry: wippy.session.api:get_session
        path: .meta.router
      - entry: wippy.session.api:get_session.endpoint
        path: .meta.router
      - entry: wippy.session.api:list_sessions
        path: .meta.router
      - entry: wippy.session.api:list_sessions.endpoint
        path: .meta.router
      - entry: wippy.session.api:session_messages
        path: .meta.router
      - entry: wippy.session.api:session_messages.endpoint
        path: .meta.router

  # Requirements
  - name: database_resource
    kind: ns.requirement
    meta:
      description: "Database resource for session storage"
    targets:
      - entry: wippy.session.env:database_resource
        path: ".default"
      - entry: wippy.session.migration:01_create_contexts_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:02_create_sessions_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:03_create_session_contexts_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:04_create_messages_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:05_create_artifacts_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:06_add_session_config_meta_fields
        path: ".meta.target_db"
      - entry: wippy.session.migration:07_migrate_session_data_to_new_structure
        path: ".meta.target_db"
      - entry: wippy.session.migration:08_remove_legacy_session_fields
        path: ".meta.target_db"
      - entry: wippy.session.migration:09_add_user_id_to_artifacts_table
        path: ".meta.target_db"
    default: "app:db"

  - name: token_checkpoint_threshold
    kind: ns.requirement
    meta:
      description: "Token count threshold for creating conversation checkpoints"
    targets:
      - entry: wippy.session.env:token_checkpoint_threshold
        path: ".default"
    default: "50000"

  - name: max_message_limit
    kind: ns.requirement
    meta:
      description: "Maximum messages to load for prompt building"
    targets:
      - entry: wippy.session.env:max_message_limit
        path: ".default"
    default: "500"

  - name: checkpoint_function_id
    kind: ns.requirement
    meta:
      description: "Function ID for generating checkpoint summaries (checkpoints enabled when set)"
    targets:
      - entry: wippy.session.env:checkpoint_function_id
        path: ".default"
    default: "wippy.session.funcs:checkpoint"

  - name: title_function_id
    kind: ns.requirement
    meta:
      description: "Function ID for generating session titles (automatic titles enabled when set)"
    targets:
      - entry: wippy.session.env:title_function_id
        path: ".default"
    default: "wippy.session.funcs:title"

  - name: default_host
    kind: ns.requirement
    meta:
      description: "Default host for session processes"
    targets:
      - entry: wippy.session.env:default_host
        path: ".default"
    default: "app:processes"

  - name: gc_interval
    kind: ns.requirement
    meta:
      description: "Garbage collection interval for session cleanup"
    targets:
      - entry: wippy.session.env:gc_interval
        path: ".default"
    default: "300s"

  - name: delegation_func_id
    kind: ns.requirement
    meta:
      description: "Function ID for delegation calls (delegation enabled when set)"
    targets:
      - entry: wippy.session.env:delegation_func_id
        path: ".default"

  # wippy.session:consts
  - name: consts
    kind: library.lua
    meta:
      comment: System-wide constants and configuration management for session system
    source: file://consts.lua
    modules:
      - env
      - time

  # Dependencies
  - name: dep.wippy.llm
    kind: ns.dependency
    component: wippy/llm
    version: ">=v0.4.0"

  - name: dep.wippy.migration
    kind: ns.dependency
    component: wippy/migration
    version: ">=v0.3.0"

  - name: dep.wippy.agent
    kind: ns.dependency
    component: wippy/agent
    version: ">=v0.4.0"

  - name: dep.wippy.views
    kind: ns.dependency
    component: wippy/views
    version: ">=v0.4.0"

  - name: dep.wippy.test
    kind: ns.dependency
    meta:
      scope: dev
    component: wippy/test
    version: "*"

  # wippy.session:start_tokens
  - name: start_tokens
    kind: library.lua
    meta:
      comment: Library for creating and validating session start tokens
    source: file://start_tokens.lua
    modules:
      - crypto
      - base64
      - json
    imports:
      consts: wippy.session:consts

  # wippy.session:start_tokens_test
  - name: start_tokens_test
    kind: function.lua
    meta:
      type: test
      suite: session
      comment: Tests the start_tokens library for creating and validating session start tokens
    source: file://start_tokens_test.lua
    modules:
      - base64
    imports:
      start_tokens: wippy.session:start_tokens
      test: wippy.test:test
    method: run

  # wippy.session:prompt_builder
  - name: prompt_builder
    kind: library.lua
    meta:
      comment: Prompt construction and formatting library for session messages
    source: file://prompt_builder.lua
    modules:
      - json
    imports:
      consts: wippy.session:consts
      prompt: wippy.llm:prompt
      upload_repo: userspace.uploads:upload_repo
