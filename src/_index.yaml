version: "1.0"
namespace: wippy.session

entries:
  # Requirements
  - name: processes_host
    kind: ns.requirement
    meta:
      description: "Application processes host ID"
    targets:
      - entry: wippy.session.process:session
        path: ".meta.default_host"

  - name: api_router
    kind: ns.requirement
    meta:
      description: "Application API router ID for HTTP endpoints"
    targets:
      - entry: env-target_api_router
        path: ".default"
      - entry: wippy.session.api:get_artifact
        path: ".meta.router"
      - entry: wippy.session.api:get_artifact.endpoint
        path: ".meta.router"
      - entry: wippy.session.api:get_artifact_content
        path: ".meta.router"
      - entry: wippy.session.api:get_artifact_content.endpoint
        path: ".meta.router"
      - entry: wippy.session.api:get_session
        path: ".meta.router"
      - entry: wippy.session.api:get_session.endpoint
        path: ".meta.router"
      - entry: wippy.session.api:list_sessions
        path: ".meta.router"
      - entry: wippy.session.api:list_sessions.endpoint
        path: ".meta.router"
      - entry: wippy.session.api:session_messages
        path: ".meta.router"
      - entry: wippy.session.api:session_messages.endpoint
        path: ".meta.router"

  - name: target_db
    kind: ns.requirement
    meta:
      description: "Application database ID"
    targets:
      - entry: env-target_db
        path: ".default"
      - entry: wippy.session.migration:01_create_contexts_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:02_create_sessions_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:03_create_session_contexts_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:04_create_messages_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:05_create_artifacts_table
        path: ".meta.target_db"
      - entry: wippy.session.migration:06_add_user_id_to_artifacts_table
        path: ".meta.target_db"

  # Dependencies
  - name: __dependency.wippy.llm
    kind: "ns.dependency"
    meta:
      description: "LLM component"
    component: "wippy/llm"
    version: ">=v0.0.12"

  - name: __dependency.wippy.migration
    kind: "ns.dependency"
    meta:
      description: "Migration component"
    component: "wippy/migration"
    version: ">=v0.0.10"

  - name: __dependency.wippy.actor
    kind: "ns.dependency"
    meta:
      description: "Actor component"
    component: "wippy/actor"
    version: ">=v0.0.10"

  - name: __dependency.wippy.agent
    kind: "ns.dependency"
    meta:
      description: "Agent component"
    component: "wippy/agent"
    version: ">=v0.0.10"

  - name: __dependency.wippy.test
    kind: "ns.dependency"
    meta:
      description: "Testing component"
    component: "wippy/test"
    version: ">=v0.0.8"

  # Environment Storage
  - name: envs
    kind: env.storage.os
    meta:
      type: envstorage
      comment: OS storage for environment variables

  # Environment Variables
  # wippy.session:env-target_api_router
  - name: env-target_api_router
    kind: env.variable
    meta:
      type: config_key
      comment: API router resource identifier
    storage: wippy.session:envs

  # wippy.session:env-target_db
  - name: env-target_db
    kind: env.variable
    meta:
      type: config_key
      comment: Database resource identifier
    storage: wippy.session:envs

  # wippy.session:start_tokens
  - name: start_tokens
    kind: library.lua
    meta:
      comment: Library for creating and validating session start tokens
      description: User sessions and conversation management system
      depends_on:
        - ns:wippy.agent
        - ns:wippy.llm
        - ns:wippy.agent.gen1
    source: file://start_tokens.lua
    modules:
      - crypto
      - base64
      - json

  # wippy.session:start_tokens_test
  - name: start_tokens_test
    kind: function.lua
    meta:
      name: Start Tokens Library Test
      type: test
      comment: Tests the start_tokens library for creating and validating session start tokens
      group: Session Tests
      tags:
        - session
        - security
        - token
        - tests
      description: User sessions and conversation management system
      depends_on:
        - ns:wippy.agent
        - ns:wippy.llm
        - ns:wippy.agent.gen1
    source: file://start_tokens_test.lua
    modules:
      - crypto
      - base64
      - json
    imports:
      start_tokens: wippy.session:start_tokens
      test: wippy.test:test
    method: run_tests
